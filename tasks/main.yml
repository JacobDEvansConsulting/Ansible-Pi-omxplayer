- name: Copy fdisk resize script
  copy: src=fdisk dest=/root/fdisk mode=755
  notify: reboot
  register: fdisk

- name: waiting for server to come back
  local_action: wait_for host={{ inventory_hostname }} state=started delay=2 timeout=300
  sudo: false
  when: fdisk.changed

- name: resize rootfs
  shell: resize2fs /dev/mmcblk0p2
  when: fdisk.changed

- name: Copy and run raspi-init
  copy: src=raspi-init.sh dest=/root/raspi-init.sh mode=755
  notify: raspi init

- name: Install list of packages
  apt: pkg={{item}} state=installed update_cache=yes
  with_items:
       - omxplayer
       - mailutils
       - scrot
       - lighttpd
       - ca-certificates
       - rpi-update
- name: Run rpi-update
  command: rpi-update

- name: Copy configuration files.
  copy: src=autostart dest=/etc/xdg/lxsession/LXDE-pi/autostart

- name: Copy configuration files.
  copy: src=lightdm dest=/etc/lightdm/lightdm.conf

- name: Copy configuration files.
  copy: src=notifyPi dest=/etc/network/if-up.d/notifyPi mode=755

- name: Copy configuration files.
  copy: src={{item}} dest=/boot/{{item}} mode=755
  with_items:
       - config.txt
       - cmdline.txt

- name: Copy configuration files.
  copy: src=rc.local dest=/etc/rc.local mode=755

- name: Download Video
  get-url: url={{ video_url }} dest=/tmp/video-file
  notify: reboot
